@page "/test/{groupUserId}"
@layout UserLayout

@if (TestQuestions != null)
{
    <div class="container py-5">
        <div class="card shadow-lg">
            <div class="card-body m-1 p-2">

                <!-- Заголовок + таймер -->
                <div class="d-flex justify-content-end align-items-center border-bottom pb-2 mb-3">
                    <Countdown @ref="Timer" TimerPause="TimerPauseCallback" TimerOut="TimerOutCallback" />
                </div>

                <!-- Прогресс -->
                <div class="mb-4">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-primary" style="width:@TestProgressPercent%">
                            @(TestQuestions.Count(t => t.AnswerId != null)) / @TestQuestions.Count
                        </div>
                    </div>
                </div>

                <!-- Вопрос -->
                <div class="mb-4">
                    <h5 class="mb-3">Вопрос @(CurrentQuestionIndex + 1): @TestQuestions[CurrentQuestionIndex].Question!.Title</h5>

                    @foreach (var answer in TestQuestions[CurrentQuestionIndex].Question!.AnswerItems!)
                    {
                        <div class="form-check" @onclick="() => SetAnswer(TestQuestions[CurrentQuestionIndex], answer.Id)">
                            <input class="form-check-input" type="radio" name="q@CurrentQuestionIndex"
                                   checked="@(TestQuestions[CurrentQuestionIndex].AnswerId == answer.Id)">
                            <label class="form-check-label">
                                @answer.Title
                            </label>
                        </div>
                    }
                </div>

                <!-- Навигация -->
                <div class="btn-group d-flex justify-content-center align-items-center gap-1 m-3" role="group" aria-label="Basic example">
                    <button class="btn btn-secondary text-nowrap" @onclick="PrevQuestion"
                            disabled="@(CurrentQuestionIndex == 0)">
                        Предыдущий вопрос
                    </button>
                    <button class="btn btn-primary text-nowrap" @onclick="NextQuestion"
                            disabled="@(CurrentQuestionIndex == TestQuestions.Count - 1)">
                        Следующий вопрос
                    </button>
                </div>
                <div class="d-flex flex-wrap justify-content-center gap-1">
                    @for (int i = 0; i < TestQuestions.Count; i++)
                    {
                        var idx = i;
                        string cssClass = "";

                        if (idx == CurrentQuestionIndex)
                            cssClass += "btn-primary"; // активный вопрос
                        else if (TestQuestions[idx].AnswerId != null)
                            cssClass += "btn-success"; // ответ дан
                        else
                            cssClass += "btn-outline-secondary"; // пустой

                        <button @key="idx" class="btn btn-sm @cssClass"
                                @onclick="() => GoToQuestion(idx)" style="width:52px;">
                            @(idx + 1)
                        </button>
                    }
                </div>

                @if (CurrentQuestionIndex == TestQuestions.Count - 1)
                {
                    <button class="btn btn-primary m-3" @onclick="CompleteTest">
                        Завершить тест
                    </button>
                }
            </div>
        </div>
    </div>
}